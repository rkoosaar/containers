name: Purge GHCR packages (repo-linked)
on:
  workflow_dispatch:
jobs:
  purge:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Create app token
        id: app
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: rkoosaar

      - name: Purge ALL container packages linked to this repo
        env:
          GH_TOKEN: ${{ steps.app.outputs.token }}
          OWNER: rkoosaar
          REPO: containers
        shell: bash
        run: |
          set -euo pipefail

          # 1) List container packages *linked to the repo*
          #    (this avoids touching packages linked to other repos)
          mapfile -t PKGS < <(gh api "/repos/$OWNER/$REPO/packages" \
            -F package_type=container --paginate -q '.[].name')

          if [[ ${#PKGS[@]} -eq 0 ]]; then
            echo "No container packages linked to $OWNER/$REPO"
            exit 0
          fi

          echo "Found ${#PKGS[@]} packages: ${PKGS[*]}"

          # 2) For each package: delete ALL versions (tagged + untagged), then delete the package
          for PKG in "${PKGS[@]}"; do
            ENC=$(jq -rn --arg s "$PKG" '$s|@uri')
            echo "::group::Purging package: $PKG"

            # Delete all versions (loop until none left)
            while : ; do
              # Grab up to 100 version IDs
              mapfile -t VERS < <(gh api "/users/$OWNER/packages/container/$ENC/versions" \
                  --paginate -q '.[].id' | head -n 100 || true)

              [[ ${#VERS[@]} -eq 0 ]] && break

              for VID in "${VERS[@]}"; do
                echo "DELETE version $VID"
                gh api -X DELETE "/users/$OWNER/packages/container/$ENC/versions/$VID" || true
              done
            done

            # Finally delete the empty package itself
            echo "DELETE package entity: $PKG"
            gh api -X DELETE "/users/$OWNER/packages/container/$ENC" || true

            echo "::endgroup::"
          done
