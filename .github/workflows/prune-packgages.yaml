name: Bulk prune GHCR
on: workflow_dispatch

jobs:
  discover:
    runs-on: ubuntu-latest
    outputs:
      pkgs: ${{ steps.list.outputs.pkgs }}
    steps:
      - id: list
        run: |
          set -euo pipefail
          # List all container package names for the user (change to /orgs/<ORG>/packages if needed)
          PKGS=$(gh api /users/rkoosaar/packages -F package_type=container --paginate -q '.[].name' | jq -R . | jq -cs .)
          echo "Found packages: $PKGS"
          echo "pkgs=$PKGS" >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ secrets.PACKAGES_TOKEN }}   # PAT with read:packages

  prune:
    needs: discover
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package: ${{ fromJson(needs.discover.outputs.pkgs) }}
    permissions:
      packages: write
    steps:
      - uses: actions/delete-package-versions@v5
        with:
          owner: rkoosaar
          package-type: container
          package-name: ${{ matrix.package }}
          min-versions-to-keep: 0
          delete-only-untagged-versions: false
          num-old-versions-to-delete: 9999
          token: ${{ secrets.PACKAGES_TOKEN }}       # PAT with delete:packages
