name: Prune GHCR
on:
  workflow_dispatch:
    inputs:
      keep:
        description: "How many newest tagged versions to keep"
        required: true
        default: "5"

jobs:
  prune:
    runs-on: ubuntu-latest
    env:
      OWNER: rkoosaar
      KEEP: ${{ inputs.keep }}
      GH_TOKEN: ${{ secrets.PACKAGES_PAT }}  # PAT with delete:packages, read:packages, repo
    steps:
      - name: Check gh auth
        run: gh auth status

      - name: List all container packages for user
        id: list
        run: |
          set -euo pipefail
          # One name per line, raw (can contain /)
          gh api "/users/$OWNER/packages" -F package_type=container --paginate -q '.[].name' > /tmp/packages.txt
          echo "Found packages:"
          cat /tmp/packages.txt

      - name: Prune packages
        run: |
          set -euo pipefail
          while IFS= read -r PKG; do
            [ -z "$PKG" ] && continue
            echo "::group::Pruning $PKG"

            # URL-encode the package name for API paths
            PKG_ENC=$(printf '%s' "$PKG" | jq -sRr @uri)

            # 1) delete UNTAGGED versions
            gh api "/users/$OWNER/packages/container/$PKG_ENC/versions" --paginate \
              -q '.[] | select(.metadata.container.tags|length==0) | .id' \
            | while read -r VID; do
                echo "Delete UNTAGGED version $VID"
                gh api -X DELETE "/users/$OWNER/packages/container/$PKG_ENC/versions/$VID" || true
              done

            # 2) keep newest $KEEP tagged; delete the rest
            gh api "/users/$OWNER/packages/container/$PKG_ENC/versions" --paginate \
              -q "[.[] | select(.metadata.container.tags|length>0)] | sort_by(.created_at) | reverse | .[$KEEP:] | .[].id" \
            | while read -r VID; do
                echo "Delete OLD tagged version $VID"
                gh api -X DELETE "/users/$OWNER/packages/container/$PKG_ENC/versions/$VID" || true
              done

            echo "::endgroup::"
          done < /tmp/packages.txt
