name: GHCR prune (user)
on:
  workflow_dispatch:
    inputs:
      keep:
        description: "How many latest tagged versions to keep"
        required: true
        default: "5"

jobs:
  prune:
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read
    steps:
      - name: Mint GitHub App token
        id: app
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Set GH_TOKEN
        run: echo "GH_TOKEN=${{ steps.app.outputs.token }}" >> $GITHUB_ENV

      - name: Prune all user-owned container packages
        env:
          OWNER: ${{ github.repository_owner }}
          KEEP: ${{ github.event.inputs.keep }}
        shell: bash
        run: |
          set -euo pipefail
          # List package *names* under the user (not org). For orgs, switch /users -> /orgs.
          gh api "/users/$OWNER/packages?package_type=container&per_page=100" --paginate -q '.[].name' \
          | while IFS= read -r PKG; do
              # URL-encode name (handles weird names)
              ENC=$(jq -rn --arg s "$PKG" '$s|@uri')
              echo "::group::Pruning package $PKG"

              # 1) delete all UNTAGGED versions
              gh api "/users/$OWNER/packages/container/$ENC/versions?per_page=100" --paginate \
                 -q '.[] | select((.metadata.container.tags|length)==0) | .id' \
              | while IFS= read -r VID; do
                  echo "Delete UNTAGGED $VID"
                  gh api -X DELETE "/users/$OWNER/packages/container/$ENC/versions/$VID" || true
                done

              # 2) keep newest $KEEP tagged, delete the rest
              gh api "/users/$OWNER/packages/container/$ENC/versions?per_page=100" --paginate \
                 -q "[.[] | select((.metadata.container.tags|length)>0)] | sort_by(.created_at) | reverse | .[$KEEP:] | .[].id" \
              | while IFS= read -r VID; do
                  echo "Delete OLD tagged $VID"
                  gh api -X DELETE "/users/$OWNER/packages/container/$ENC/versions/$VID" || true
                done

              echo "::endgroup::"
            done
