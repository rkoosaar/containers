name: wipe-ghcr-user
on:
  workflow_dispatch:

jobs:
  nuke-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # REQUIRED for delete
    env:
      OWNER: rkoosaar
    steps:
      - name: Ensure gh has a token
        run: echo "GH_TOKEN is ${{ github.token && 'set' || 'missing' }}"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Delete ALL container package versions and packages (USER)
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}  # gh CLI reads this
        run: |
          set -euo pipefail

          # 1) list user-owned container PACKAGE NAMES (these are NOT repo names)
          mapfile -t PKGS < <(
            gh api "/users/$OWNER/packages" -F package_type=container --paginate -q '.[].name'
          )

          if [[ ${#PKGS[@]} -eq 0 ]]; then
            echo "No container packages found for user $OWNER"
            exit 0
          fi

          for PKG in "${PKGS[@]}"; do
            # URL-encode for path
            ENC="$(jq -rn --arg s "$PKG" '$s|@uri')"
            echo "::group::Pruning package: $PKG"

            # 2) delete ALL versions (tagged + untagged) in pages until none remain
            while :; do
              # grab up to 100 version ids
              mapfile -t VERS < <(
                gh api "/users/$OWNER/packages/container/$ENC/versions?per_page=100" --paginate -q '.[].id' | head -n 100
              ) || true

              [[ ${#VERS[@]} -eq 0 ]] && break

              for VID in "${VERS[@]}"; do
                echo "DELETE version $VID"
                gh api -X DELETE "/users/$OWNER/packages/container/$ENC/versions/$VID" || true
              done
            done

            # 3) delete the now-empty package object
            echo "DELETE package object: $PKG"
            gh api -X DELETE "/users/$OWNER/packages/container/$ENC" || true

            echo "::endgroup::"
          done
