name: Purge ALL GHCR packages (user)

on:
  workflow_dispatch:

jobs:
  purge-ghcr:
    runs-on: ubuntu-latest
    permissions:
      packages: write        # required to delete package versions
      contents: read
    steps:
      - name: App token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }}

      - name: Purge all user packages (containers)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          OWNER: ${{ github.repository_owner }}
        shell: bash
        run: |
          set -euo pipefail

          # List container package NAMES owned by the USER (switch /users -> /orgs for org-owned)
          mapfile -t PKGS < <(gh api "/users/${OWNER}/packages" \
                                  -F package_type=container \
                                  --paginate \
                                  -q '.[].name')

          if [[ ${#PKGS[@]} -eq 0 ]]; then
            echo "No container packages found for user ${OWNER}"
            exit 0
          fi

          for PKG in "${PKGS[@]}"; do
            # URL-encode package name for path segments (handles names like "containers/my-image")
            ENC="$(jq -rn --arg s "$PKG" '$s|@uri')"

            echo "::group::Deleting ALL versions of package: $PKG"

            # Delete ALL versions (tagged + untagged); repeat until none remain (handles pagination/races)
            while : ; do
              IDS=$(gh api "/users/${OWNER}/packages/container/${ENC}/versions" \
                        --paginate -q '.[].id' || true)
              [[ -z "${IDS}" ]] && break
              while read -r VID; do
                [[ -z "${VID}" ]] && continue
                echo "DELETE version ${VID}"
                gh api -X DELETE "/users/${OWNER}/packages/container/${ENC}/versions/${VID}" || true
              done <<< "${IDS}"
            done

            echo "Trying to delete the now-empty package itselfâ€¦"
            # Delete the package object (ignore failure if the endpoint is restricted)
            gh api -X DELETE "/users/${OWNER}/packages/container/${ENC}" || true

            echo "::endgroup::"
          done
