name: Prune GHCR
on:
  workflow_dispatch:

jobs:
  prune:
    runs-on: ubuntu-latest
    steps:
      - name: App token
        id: app-token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: ${{ github.repository_owner }} # user or org that owns the packages

      - name: Prune untagged & old versions (user-owned packages)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          OWNER: ${{ github.repository_owner }}
          KEEP: "5"                    # keep N newest tagged versions (per package)
        run: |
          set -euo pipefail

          # List all container package NAMES under the user (change /users -> /orgs for org-owned)
          gh api "/users/$OWNER/packages" -F package_type=container --paginate -q '.[].name' | while read -r PKG; do
            echo "::group::Pruning package $PKG"

            # 1) Delete all UNTAGGED versions
            gh api "/users/$OWNER/packages/container/$PKG/versions" --paginate \
              -q '.[] | select(.metadata.container.tags|length==0) | .id' | while read -r VID; do
              echo "Delete UNTAGGED version $VID"
              gh api -X DELETE "/users/$OWNER/packages/container/$PKG/versions/$VID" || true
            done

            # 2) Keep the newest $KEEP tagged; delete the rest
            #    Sort by created_at desc, skip first $KEEP, delete remaining
            gh api "/users/$OWNER/packages/container/$PKG/versions" --paginate \
              -q "[.[] | select(.metadata.container.tags|length>0)] | sort_by(.created_at) | reverse | .[$KEEP:] | .[].id" \
              | while read -r VID; do
                echo "Delete OLD tagged version $VID"
                gh api -X DELETE "/users/$OWNER/packages/container/$PKG/versions/$VID" || true
              done

            echo "::endgroup::"
          done
