name: Nuke all GHCR packages (USER)

on:
  workflow_dispatch: {}

jobs:
  nuke-user-ghcr:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # IMPORTANT for deleting package versions
    steps:
      - id: app-token
        name: Get GitHub App token
        uses: actions/create-github-app-token@v2
        with:
          app-id: ${{ secrets.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}
          owner: rkoosaar

      - name: Delete ALL container packages + versions (user)
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
          OWNER: rkoosaar
        shell: bash
        run: |
          set -euo pipefail

          echo "Listing container packages for user '$OWNER'..."
          # get package names
          mapfile -t PKGS < <(gh api "/users/$OWNER/packages" \
            -F package_type=container --paginate -q '.[].name')

          if [[ ${#PKGS[@]} -eq 0 ]]; then
            echo "No container packages found for user '$OWNER'. Done."
            exit 0
          fi

          for PKG in "${PKGS[@]}"; do
            ENC=$(jq -rn --arg s "$PKG" '$s|@uri')
            echo "::group::Purging package: $PKG"

            # 1) delete ALL versions (tagged + untagged)
            mapfile -t VERS < <(gh api "/users/$OWNER/packages/container/$ENC/versions?per_page=100" \
              --paginate -q '.[].id' || true)

            if [[ ${#VERS[@]} -eq 0 ]]; then
              echo "No versions found for $PKG"
            else
              for VID in "${VERS[@]}"; do
                echo "DELETE version $VID"
                gh api -X DELETE "/users/$OWNER/packages/container/$ENC/versions/$VID" || true
              done
            fi

            # 2) try to delete the empty package shell
            gh api -X DELETE "/users/$OWNER/packages/container/$ENC" || true

            echo "::endgroup::"
          done
