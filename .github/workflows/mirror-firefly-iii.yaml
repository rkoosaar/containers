name: Mirror Firefly III → GHCR (core + DATA-IMPORTER)

on:
  # schedule:
  #   - cron: "37 4 * * *"        # daily
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      OWNER: ${{ github.repository_owner }}
      SRC_REG: docker.io
      DEST_REG: ghcr.io

      # Upstream repos
      SRC_CORE: fireflyiii/core
      SRC_DATA_IMPORTER: fireflyiii/data-importer

      # Destination names in GHCR
      DEST_CORE: firefly-iii
      DEST_DATA_IMPORTER: firefly-iii-data-importer

      # Static version sets to ensure are mirrored (numeric only; we'll also add version-*)
      CORE_VERSIONS: "6.2.10 6.2.21 6.3.0 6.3.2 6.4.0 6.4.4 6.4.5"
      DATA_IMPORTER_VERSIONS: "1.5.1 1.6.1 1.7.1 1.7.10 1.8.1 1.8.4 1.9.0"
    steps:
      - name: Install skopeo & jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y skopeo jq

      - name: Resolve CORE latest version (from labels or digest)
        id: corever
        shell: bash
        run: |
          set -euo pipefail
          meta_json="$(skopeo inspect --config docker://${SRC_REG}/${SRC_CORE}:latest)"
          ver="$(echo "$meta_json" \
            | jq -r '.config.Labels["org.opencontainers.image.version"]
                      // .config.Labels["org.label-schema.version"]
                      // .config.Labels["version"]
                      // empty' | head -n1)"
          if [[ -z "${ver:-}" || "${ver}" == "null" ]]; then
            digest="$(skopeo inspect docker://${SRC_REG}/${SRC_CORE}:latest | jq -r .Digest)"
            ver="sha256-$(echo "$digest" | cut -d: -f2 | cut -c1-12)"
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: Resolve DATA-IMPORTER latest version (from labels or digest)
        id: divever
        shell: bash
        run: |
          set -euo pipefail
          meta_json="$(skopeo inspect --config docker://${SRC_REG}/${SRC_DATA_IMPORTER}:latest)"
          ver="$(echo "$meta_json" \
            | jq -r '.config.Labels["org.opencontainers.image.version"]
                      // .config.Labels["org.label-schema.version"]
                      // .config.Labels["version"]
                      // empty' | head -n1)"
          if [[ -z "${ver:-}" || "${ver}" == "null" ]]; then
            digest="$(skopeo inspect docker://${SRC_REG}/${SRC_DATA_IMPORTER}:latest | jq -r .Digest)"
            ver="sha256-$(echo "$digest" | cut -d: -f2 | cut -c1-12)"
          fi
          echo "version=$ver" >> "$GITHUB_OUTPUT"

      - name: GHCR login (for pushes)
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login --username "${{ github.actor }}" --password-stdin ${DEST_REG}

      - name: Helper | copy_if_missing()
        id: helpers
        shell: bash
        run: |
          set -euo pipefail
          cat > /tmp/copy_if_missing.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail
          SRC_REF="$1"; shift
          DEST_BASE="$1"; shift
          # Remaining args are tags to create at DEST_BASE
          for TAG in "$@"; do
            DEST_REF="${DEST_BASE}:${TAG}"
            if skopeo inspect "docker://${DEST_REF}" >/dev/null 2>&1; then
              echo "✅ Skip (exists): ${DEST_REF}"
              continue
            fi
            echo "→ Copying ${SRC_REF}  →  ${DEST_REF}"
            skopeo copy --all "docker://${SRC_REF}" "docker://${DEST_REF}"
          done
          EOF
          chmod +x /tmp/copy_if_missing.sh

      # =======================
      # CORE (latest + pinned)
      # =======================
      - name: CORE | Mirror latest → latest, version-x.y.z, x.y.z
        shell: bash
        run: |
          set -euo pipefail
          CORE_LATEST_VER="${{ steps.corever.outputs.version }}"
          SRC="{$SRC_REG}/${SRC_CORE}:latest"
          DEST="${DEST_REG}/${OWNER}/${DEST_CORE}"
          /tmp/copy_if_missing.sh "${SRC}" "${DEST}" "latest" "version-${CORE_LATEST_VER}" "${CORE_LATEST_VER}"

      - name: CORE | Mirror specific versions (numeric + version-*)
        shell: bash
        run: |
          set -euo pipefail
          DEST="${DEST_REG}/${OWNER}/${DEST_CORE}"
          for V in ${CORE_VERSIONS}; do
            SRC="${SRC_REG}/${SRC_CORE}:${V}"
            /tmp/copy_if_missing.sh "${SRC}" "${DEST}" "${V}" "version-${V}"
          done

      # ============================
      # DATA-IMPORTER (latest + set)
      # ============================
      - name: DATA-IMPORTER | Mirror latest → latest, version-x.y.z, x.y.z
        shell: bash
        run: |
          set -euo pipefail
          DI_LATEST_VER="${{ steps.divever.outputs.version }}"
          SRC="${SRC_REG}/${SRC_DATA_IMPORTER}:latest"
          DEST="${DEST_REG}/${OWNER}/${DEST_DATA_IMPORTER}"
          /tmp/copy_if_missing.sh "${SRC}" "${DEST}" "latest" "version-${DI_LATEST_VER}" "${DI_LATEST_VER}"

      - name: DATA-IMPORTER | Mirror specific versions (numeric + version-*)
        shell: bash
        run: |
          set -euo pipefail
          DEST="${DEST_REG}/${OWNER}/${DEST_DATA_IMPORTER}"
          for V in ${DATA_IMPORTER_VERSIONS}; do
            SRC="${SRC_REG}/${SRC_DATA_IMPORTER}:${V}"
            /tmp/copy_if_missing.sh "${SRC}" "${DEST}" "${V}" "version-${V}"
          done
