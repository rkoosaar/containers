name: Mirror Firefly III → GHCR (latest + version-x.y.z + numeric)

on:
  # schedule:
  #   - cron: "37 4 * * *"    # daily
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    env:
      OWNER: ${{ github.repository_owner }}

      # Upstream registries/repositories
      SRC_REG: docker.io
      SRC_CORE: fireflyiii/core
      SRC_DATA_IMPORTER: fireflyiii/data-importer

      # Dest (your GHCR repos)
      DEST_REG: ghcr.io
      DEST_CORE: firefly-iii
      DEST_DATA_IMPORTER: firefly-iii-data-importer

      # Extra versions to copy (as they exist upstream)
      CORE_EXTRA_TAGS: "version-6.2.10 version-6.2.21 version-6.3.0 version-6.3.2 version-6.4.0 version-6.4.4 version-6.4.5"
      DATA_IMPORTER_EXTRA_TAGS: "version-1.5.1 version-1.6.1 version-1.7.1 version-1.7.10 version-1.8.1 version-1.8.4 version-1.9.0"

    steps:
      - name: Install skopeo & jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y skopeo jq

      - name: Define helpers
        id: helpers
        shell: bash
        run: |
          set -euo pipefail

          cat <<'EOF' > /tmp/helpers.sh
          #!/usr/bin/env bash
          set -euo pipefail

          dest_creds() {
            echo "${GITHUB_ACTOR}:${GITHUB_TOKEN}"
          }

          # Copy src->dest if dest tag doesn't already exist.
          copy_if_missing() {
            local src="$1"   # e.g. docker://docker.io/fireflyiii/core:latest
            local dst="$2"   # e.g. docker://ghcr.io/OWNER/firefly-iii:latest

            if skopeo inspect "$dst" --creds "$(dest_creds)" >/dev/null 2>&1; then
              echo "✓ Exists, skipping: $dst"
              return 0
            fi

            echo "→ Copying $src  →  $dst"
            skopeo copy --all "$src" "$dst" \
              ${SRC_CREDS:+--src-creds "$SRC_CREDS"} \
              --dest-creds "$(dest_creds)"
          }

          # Read a semantic version from OCI labels (fallback to digest short).
          discover_version_from_labels() {
            local src="$1"
            local cfg; cfg="$(skopeo inspect --config "$src" ${SRC_CREDS:+--creds "$SRC_CREDS"})" || return 1
            local v
            v="$(echo "$cfg" | jq -r '
              .config.Labels["org.opencontainers.image.version"] //
              .config.Labels["org.label-schema.version"] //
              .config.Labels["version"] // empty
            ')"
            if [[ -n "${v:-}" && "$v" != "null" ]]; then
              echo "$v"
              return 0
            fi
            # Fallback to digest-derived tag
            local dig; dig="$(skopeo inspect "$src" ${SRC_CREDS:+--creds "$SRC_CREDS"} | jq -r .Digest)"
            echo "sha256-$(echo "$dig" | cut -d: -f2 | cut -c1-12)"
          }

          # Turn "version-6.4.5" -> "6.4.5" (plain numeric). If already numeric, returns as-is.
          to_numeric_tag() {
            local t="$1"
            echo "${t#version-}"
          }
          EOF

          chmod +x /tmp/helpers.sh

      - name: Mirror CORE: latest + labeled version + numeric
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source /tmp/helpers.sh

          SRC="docker://${SRC_REG}/${SRC_CORE}:latest"
          DST_BASE="docker://${DEST_REG}/${OWNER}/${DEST_CORE}"

          ver="$(discover_version_from_labels "$SRC")"
          num="$(to_numeric_tag "$ver")"

          # Ensure upstream "latest" → GHCR "latest"
          copy_if_missing "$SRC" "${DST_BASE}:latest"

          # Also tag version-x.y.z (from labels on latest)
          copy_if_missing "$SRC" "${DST_BASE}:version-${ver}"

          # Also tag plain numeric x.y.z
          copy_if_missing "$SRC" "${DST_BASE}:${num}"

      - name: Mirror CORE: explicit extra tags (and numeric aliases)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source /tmp/helpers.sh

          DST_BASE="docker://${DEST_REG}/${OWNER}/${DEST_CORE}"

          for tag in ${CORE_EXTRA_TAGS}; do
            SRC="docker://${SRC_REG}/${SRC_CORE}:${tag}"
            copy_if_missing "$SRC" "${DST_BASE}:${tag}"

            num="$(to_numeric_tag "$tag")"
            copy_if_missing "$SRC" "${DST_BASE}:${num}"
          done

      - name: Mirror DATA-IMPORTER: latest + labeled version + numeric
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source /tmp/helpers.sh

          SRC="docker://${SRC_REG}/${SRC_DATA_IMPORTER}:latest"
          DST_BASE="docker://${DEST_REG}/${OWNER}/${DEST_DATA_IMPORTER}"

          ver="$(discover_version_from_labels "$SRC")"
          num="$(to_numeric_tag "$ver")"

          # Ensure upstream "latest" → GHCR "latest"
          copy_if_missing "$SRC" "${DST_BASE}:latest"

          # Tag version-x.y.z derived from latest (e.g., version-1.9.1)
          copy_if_missing "$SRC" "${DST_BASE}:version-${ver}"

          # Tag plain numeric (e.g., 1.9.1)
          copy_if_missing "$SRC" "${DST_BASE}:${num}"

      - name: Mirror DATA-IMPORTER: explicit extra tags (and numeric aliases)
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          source /tmp/helpers.sh

          DST_BASE="docker://${DEST_REG}/${OWNER}/${DEST_DATA_IMPORTER}"

          for tag in ${DATA_IMPORTER_EXTRA_TAGS}; do
            SRC="docker://${SRC_REG}/${SRC_DATA_IMPORTER}:${tag}"
            copy_if_missing "$SRC" "${DST_BASE}:${tag}"

            num="$(to_numeric_tag "$tag")"
            copy_if_missing "$SRC" "${DST_BASE}:${num}"
          done
