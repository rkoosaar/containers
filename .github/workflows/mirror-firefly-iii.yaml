name: Mirror Firefly III → GHCR

on:
  schedule:
    - cron: "17 4 * * *"   # daily; adjust as desired
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write   # required to push to GHCR
    env:
      OWNER: ${{ github.repository_owner }}
      SRC_REG: docker.io
      SRC_CORE: fireflyiii/core
      SRC_IMPORTER: fireflyiii/data-importer
      DEST_REG: ghcr.io
      DEST_CORE: firefly-iii
      DEST_IMPORTER: firefly-iii-importer

      # Fixed version lists you asked for
      CORE_FIXED: "version-6.2.10 version-6.2.21 version-6.3.0 version-6.3.2 version-6.4.0 version-6.4.4 version-6.4.5"
      IMPORTER_FIXED: "version-1.5.1 version-1.6.1 version-1.7.1 version-1.7.10 version-1.8.1 version-1.8.4 version-1.9.0"

    steps:
      - name: Install skopeo & jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y skopeo jq

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Define helper functions
        shell: bash
        run: |
          set -euo pipefail

          cat > helpers.sh <<'EOF'
          #!/usr/bin/env bash
          set -euo pipefail

          exists_on_ghcr() {
            local repo="$1" tag="$2"
            if skopeo inspect "docker://ghcr.io/${{ env.OWNER }}/${repo}:${tag}" >/dev/null 2>&1; then
              return 0
            else
              return 1
            fi
          }

          # Copy from Docker Hub upstream to GHCR (multi-arch), but skip if dest tag exists
          copy_from_upstream_if_missing() {
            local src_repo="$1" src_tag="$2" dest_repo="$3" dest_tag="$4"
            if exists_on_ghcr "$dest_repo" "$dest_tag"; then
              echo "✓ Skip: ghcr.io/${{ env.OWNER }}/${dest_repo}:${dest_tag} already exists"
              return 0
            fi
            echo "→ Copy: docker://${{ env.SRC_REG }}/${src_repo}:${src_tag} → ghcr.io/${{ env.OWNER }}/${dest_repo}:${dest_tag}"
            skopeo copy --all \
              "docker://${{ env.SRC_REG }}/${src_repo}:${src_tag}" \
              "docker://ghcr.io/${{ env.OWNER }}/${dest_repo}:${dest_tag}"
          }

          # Create/ensure an alias tag on GHCR by copying GHCR→GHCR (cheap and fast), skip if exists
          alias_tag_if_missing() {
            local repo="$1" existing_tag="$2" new_tag="$3"
            if exists_on_ghcr "$repo" "$new_tag"; then
              echo "✓ Skip alias: ghcr.io/${{ env.OWNER }}/${repo}:${new_tag} exists"
              return 0
            fi
            echo "→ Alias: ghcr.io/${{ env.OWNER }}/${repo}:${existing_tag} → :${new_tag}"
            skopeo copy --all \
              "docker://ghcr.io/${{ env.OWNER }}/${repo}:${existing_tag}" \
              "docker://ghcr.io/${{ env.OWNER }}/${repo}:${new_tag}"
          }

          # Extract upstream version label for a given (upstream) repo:tag.
          resolve_version_label() {
            local upstream_repo="$1" upstream_tag="$2"
            local cfg
            if ! cfg="$(skopeo inspect --config "docker://${{ env.SRC_REG }}/${upstream_repo}:${upstream_tag}")"; then
              echo ""
              return 0
            fi
            local v
            v="$(echo "$cfg" | jq -r '
              .config.Labels["org.opencontainers.image.version"] //
              .config.Labels["org.label-schema.version"] //
              .config.Labels["version"] //
              empty
            ')"
            echo "$v"
          }

          # From "version-x.y.z" → "x.y.z"
          strip_prefix_version() {
            local tag="$1"
            echo "$tag" | sed -E 's/^version-//'
          }

          # Quick x.y.z sanity check
          is_semver_triplet() {
            [[ "$1" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]
          }
          EOF

          chmod +x helpers.sh

      - name: Mirror CORE (latest + derived tags + fixed versions)
        shell: bash
        run: |
          set -euo pipefail
          source ./helpers.sh

          # 1) Mirror upstream "latest" to GHCR
          copy_from_upstream_if_missing "${SRC_CORE}" "latest" "${DEST_CORE}" "latest"

          # 2) Resolve the upstream version for latest, then add version-x.y.z and numeric x.y.z aliases
          core_ver="$(resolve_version_label "${SRC_CORE}" "latest" || true)"
          if [[ -n "${core_ver}" && "${core_ver}" != "null" ]]; then
            if is_semver_triplet "${core_ver}"; then
              alias_tag_if_missing "${DEST_CORE}" "latest" "version-${core_ver}"
              alias_tag_if_missing "${DEST_CORE}" "latest" "${core_ver}"
            else
              echo "Note: resolved version '${core_ver}' does not look like x.y.z; skipping numeric alias."
              alias_tag_if_missing "${DEST_CORE}" "latest" "version-${core_ver}"
            fi
          else
            echo "Note: no version label found on upstream CORE:latest; only 'latest' will be updated."
          fi

          # 3) Copy fixed CORE versions you listed, and add numeric tag alongside
          for tag in ${CORE_FIXED}; do
            copy_from_upstream_if_missing "${SRC_CORE}" "${tag}" "${DEST_CORE}" "${tag}"
            numeric="$(strip_prefix_version "${tag}")"
            if is_semver_triplet "${numeric}"; then
              alias_tag_if_missing "${DEST_CORE}" "${tag}" "${numeric}"
            fi
          done

      - name: Mirror IMPORTER (latest + derived tags + fixed versions)
        shell: bash
        run: |
          set -euo pipefail
          source ./helpers.sh

          # 1) Mirror upstream "latest" to GHCR
          copy_from_upstream_if_missing "${SRC_IMPORTER}" "latest" "${DEST_IMPORTER}" "latest"

          # 2) Resolve importer latest version; add version-x.y.z and numeric x.y.z
          imp_ver="$(resolve_version_label "${SRC_IMPORTER}" "latest" || true)"
          if [[ -n "${imp_ver}" && "${imp_ver}" != "null" ]]; then
            if is_semver_triplet "${imp_ver}"; then
              alias_tag_if_missing "${DEST_IMPORTER}" "latest" "version-${imp_ver}"
              alias_tag_if_missing "${DEST_IMPORTER}" "latest" "${imp_ver}"
            else
              echo "Note: resolved importer version '${imp_ver}' not x.y.z; skipping numeric alias."
              alias_tag_if_missing "${DEST_IMPORTER}" "latest" "version-${imp_ver}"
            fi
          else
            echo "Note: no version label found on upstream IMPORTER:latest; only 'latest' will be updated."
          fi

          # 3) Copy fixed IMPORTER versions you listed, and add numeric tag alongside
          for tag in ${IMPORTER_FIXED}; do
            copy_from_upstream_if_missing "${SRC_IMPORTER}" "${tag}" "${DEST_IMPORTER}" "${tag}"
            numeric="$(strip_prefix_version "${tag}")"
            if is_semver_triplet "${numeric}"; then
              alias_tag_if_missing "${DEST_IMPORTER}" "${tag}" "${numeric}"
            fi
          done
