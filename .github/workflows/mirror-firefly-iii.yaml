name: Mirror Firefly III → GHCR (core + DATA-IMPORTER)

on:
  # schedule:
  #   - cron: "37 4 * * *"   # daily
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    env:
      OWNER: ${{ github.repository_owner }}
      SRC_REG: docker.io
      SRC_CORE: fireflyiii/core
      SRC_IMPORTER: fireflyiii/data-importer
      DEST_REG: ghcr.io
      DEST_CORE: firefly-iii
      DEST_IMPORTER: firefly-iii-data-importer

      # Explicit lists you requested
      CORE_REQUESTED: >-
        version-6.2.10
        version-6.2.21
        version-6.3.0
        version-6.3.2
        version-6.4.0
        version-6.4.4

      IMPORTER_REQUESTED: >-
        version-1.5.1
        version-1.6.1
        version-1.7.1
        version-1.7.10
        version-1.8.1
        version-1.8.4
        version-1.9.0
    steps:
      - name: Install skopeo & jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y skopeo jq

      - name: Log in to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | skopeo login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Define helpers
        shell: bash
        run: |
          set -euo pipefail

          copy_if_missing() {
            local src_ref="$1"    # e.g. docker://docker.io/fireflyiii/core:latest
            local dest_repo="$2"  # e.g. ghcr.io/OWNER/firefly-iii
            local dest_tag="$3"   # e.g. latest

            if skopeo inspect "docker://${dest_repo}:${dest_tag}" > /dev/null 2>&1; then
              echo "✅ Skip: ${dest_repo}:${dest_tag} already exists"
              return 0
            fi

            echo "→ Copying ${src_ref}  →  docker://${dest_repo}:${dest_tag}"
            skopeo copy --all "docker://${src_ref}" "docker://${dest_repo}:${dest_tag}"
          }

          # Resolve a semantic version (x.y.z) from image labels, fallback to digest
          resolve_semver_or_digest() {
            local src_ref="$1"
            local cfg; cfg="$(skopeo inspect --config "docker://${src_ref}")" || cfg="{}"
            local semver
            semver="$(echo "$cfg" | jq -r '
              .config.Labels["org.opencontainers.image.version"] //
              .config.Labels["org.label-schema.version"] //
              .config.Labels["version"] //
              empty
            ' | head -n1)"

            if [[ -z "${semver:-}" || "${semver}" == "null" ]]; then
              local digest; digest="$(skopeo inspect "docker://${src_ref}" | jq -r .Digest)"
              semver="sha256-$(echo "$digest" | cut -d: -f2 | cut -c1-12)"
            fi
            echo "$semver"
          }

          # Make helper functions available to later steps
          declare -f copy_if_missing > /tmp/helpers.sh
          declare -f resolve_semver_or_digest >> /tmp/helpers.sh

      - name: Mirror CORE (latest, version-x.y.z + numeric, plus requested tags)
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/helpers.sh

          SRC_REG="${SRC_REG}"
          SRC_CORE="${SRC_CORE}"
          DEST_REG="${DEST_REG}"
          OWNER="${OWNER}"
          DEST_CORE="${DEST_CORE}"

          dest_repo="${DEST_REG}/${OWNER}/${DEST_CORE}"

          # 1) Mirror upstream "latest"
          copy_if_missing "${SRC_REG}/${SRC_CORE}:latest" "${dest_repo}" "latest"

          # 2) Read version from "latest" and tag as version-x.y.z + x.y.z
          latest_semver="$(resolve_semver_or_digest "${SRC_REG}/${SRC_CORE}:latest")"
          if [[ -n "${latest_semver}" ]]; then
            copy_if_missing "${SRC_REG}/${SRC_CORE}:latest" "${dest_repo}" "version-${latest_semver}"
            # Also plain numeric tag (A+C)
            copy_if_missing "${SRC_REG}/${SRC_CORE}:latest" "${dest_repo}" "${latest_semver}"
          fi

          # 3) Ensure the requested fixed versions exist (version-x.y.z + numeric)
          for tag in ${CORE_REQUESTED}; do
            # version-6.4.5 → numeric "6.4.5"
            numeric="${tag#version-}"
            copy_if_missing "${SRC_REG}/${SRC_CORE}:${tag}" "${dest_repo}" "${tag}"
            copy_if_missing "${SRC_REG}/${SRC_CORE}:${tag}" "${dest_repo}" "${numeric}"
          done

      - name: Mirror DATA-IMPORTER (latest, newest version-x.y.z + numeric, plus requested tags)
        shell: bash
        run: |
          set -euo pipefail
          source /tmp/helpers.sh

          SRC_REG="${SRC_REG}"
          SRC_IMPORTER="${SRC_IMPORTER}"
          DEST_REG="${DEST_REG}"
          OWNER="${OWNER}"
          DEST_IMPORTER="${DEST_IMPORTER}"

          dest_repo="${DEST_REG}/${OWNER}/${DEST_IMPORTER}"

          # 1) Mirror upstream "latest"
          copy_if_missing "${SRC_REG}/${SRC_IMPORTER}:latest" "${dest_repo}" "latest"

          # 2) Resolve semver from latest and add version-x.y.z + numeric
          importer_semver="$(resolve_semver_or_digest "${SRC_REG}/${SRC_IMPORTER}:latest")"
          if [[ -n "${importer_semver}" ]]; then
            copy_if_missing "${SRC_REG}/${SRC_IMPORTER}:latest" "${dest_repo}" "version-${importer_semver}"
            copy_if_missing "${SRC_REG}/${SRC_IMPORTER}:latest" "${dest_repo}" "${importer_semver}"
          fi

          # 3) Ensure requested fixed versions (incl. 1.9.1)
          for tag in ${IMPORTER_REQUESTED}; do
            numeric="${tag#version-}"
            copy_if_missing "${SRC_REG}/${SRC_IMPORTER}:${tag}" "${dest_repo}" "${tag}"
            copy_if_missing "${SRC_REG}/${SRC_IMPORTER}:${tag}" "${dest_repo}" "${numeric}"
          done
